THREE.CSS3DObject=function(e){THREE.Object3D.call(this),this.element=e,this.element.style.position="absolute",this.addEventListener("removed",function(e){null!==this.element.parentNode&&this.element.parentNode.removeChild(this.element)})},THREE.CSS3DObject.prototype=Object.create(THREE.Object3D.prototype),THREE.CSS3DObject.prototype.constructor=THREE.CSS3DObject,THREE.CSS3DSprite=function(e){THREE.CSS3DObject.call(this,e)},THREE.CSS3DSprite.prototype=Object.create(THREE.CSS3DObject.prototype),THREE.CSS3DSprite.prototype.constructor=THREE.CSS3DSprite,THREE.CSS3DRenderer=function(){console.log("THREE.CSS3DRenderer",THREE.REVISION);var e,t,n,r,o=new THREE.Matrix4,i={camera:{fov:0,style:""},objects:{}},s=document.createElement("div");s.style.overflow="hidden",s.style.WebkitTransformStyle="preserve-3d",s.style.MozTransformStyle="preserve-3d",s.style.oTransformStyle="preserve-3d",s.style.transformStyle="preserve-3d",this.domElement=s;var a=document.createElement("div");a.style.WebkitTransformStyle="preserve-3d",a.style.MozTransformStyle="preserve-3d",a.style.oTransformStyle="preserve-3d",a.style.transformStyle="preserve-3d",s.appendChild(a),this.setClearColor=function(){},this.getSize=function(){return{width:e,height:t}},this.setSize=function(o,i){e=o,t=i,n=e/2,r=t/2,s.style.width=o+"px",s.style.height=i+"px",a.style.width=o+"px",a.style.height=i+"px"};var c=function(e){return Math.abs(e)<1e-6?0:e},l=function(e){var t=e.elements;return"matrix3d("+c(t[0])+","+c(-t[1])+","+c(t[2])+","+c(t[3])+","+c(t[4])+","+c(-t[5])+","+c(t[6])+","+c(t[7])+","+c(t[8])+","+c(-t[9])+","+c(t[10])+","+c(t[11])+","+c(t[12])+","+c(-t[13])+","+c(t[14])+","+c(t[15])+")"},u=function(e){var t=e.elements;return"translate3d(-50%,-50%,0) matrix3d("+c(t[0])+","+c(t[1])+","+c(t[2])+","+c(t[3])+","+c(-t[4])+","+c(-t[5])+","+c(-t[6])+","+c(-t[7])+","+c(t[8])+","+c(t[9])+","+c(t[10])+","+c(t[11])+","+c(t[12])+","+c(t[13])+","+c(t[14])+","+c(t[15])+")"},d=function(e,t){if(e instanceof THREE.CSS3DObject){var n;e instanceof THREE.CSS3DSprite?(o.copy(t.matrixWorldInverse),o.transpose(),o.copyPosition(e.matrixWorld),o.scale(e.scale),o.elements[3]=0,o.elements[7]=0,o.elements[11]=0,o.elements[15]=1,n=u(o)):n=u(e.matrixWorld);var r=e.element,s=i.objects[e.id];(void 0===s||s!==n)&&(r.style.WebkitTransform=n,r.style.MozTransform=n,r.style.oTransform=n,r.style.transform=n,i.objects[e.id]=n),r.parentNode!==a&&a.appendChild(r)}for(var c=0,l=e.children.length;l>c;c++)d(e.children[c],t)};this.render=function(e,o){var c=.5/Math.tan(THREE.Math.degToRad(.5*o.fov))*t;i.camera.fov!==c&&(s.style.WebkitPerspective=c+"px",s.style.MozPerspective=c+"px",s.style.oPerspective=c+"px",s.style.perspective=c+"px",i.camera.fov=c),e.updateMatrixWorld(),null===o.parent&&o.updateMatrixWorld(),o.matrixWorldInverse.getInverse(o.matrixWorld);var u="translate3d(0,0,"+c+"px)"+l(o.matrixWorldInverse)+" translate3d("+n+"px,"+r+"px, 0)";i.camera.style!==u&&(a.style.WebkitTransform=u,a.style.MozTransform=u,a.style.oTransform=u,a.style.transform=u,i.camera.style=u),d(e,o)}},function(e,t,n){function r(e){function t(){var t=e.key||"x6wcgg5nrtuzncdi",n=e.iceServers||[{url:"stun://stun.l.google.com:19302"},{url:"stun://stun1.l.google.com:19302"},{url:"stun://stun2.l.google.com:19302"},{url:"stun://stun3.l.google.com:19302"},{url:"stun://stun4.l.google.com:19302"}];return u=new Peer({key:t,config:{iceServers:n}}),u.on("open",function(e){l("Your peer ID is: "+e),p.emit("p2p.open",e)}),u.on("connection",r),u.on("error",function(e){l("Peer error: "+e),p.emit("p2p.error",e)}),u}function r(e){var t=e.peer;d[t]=e,e.on("data",function(r){switch(r.type){case"peers4u":var i=r.data;_.forEach(i,function(e){d[e]===n&&o(e)});break;default:c(r,t,e)}}),e.on("open",function(){l(t+" opened"),i(t),p.emit("p2p.peer.open",t)}),e.on("close",function(){l(t+" closed"),delete d[t],p.emit("p2p.peer.close",t)}),e.on("error",function(e){l(t+" error: "+e),p.emit("p2p.peer.error",t,e)})}function o(e){if(d[e]===n){var t=u.connect(e);r(t)}}function i(e){var t=d[e];if(t){var n=_.filter(_.keys(d),function(t){return t!=e});a(e,"peers4u",n)}}function s(e,t){var n={type:e,data:t};_.forEach(d,function(e){e.send(n)})}function a(e,t,n){var r={type:t,data:n},o=d[e];o.send(r)}function c(e,t,n){var r=e.type;r&&p.emit("p2p.in."+r,e.data,t,n)}function l(e){console&&console.log&&console.log(e)}var u,d={},p=e.sewerBus;return{setupClient:t,connectTo:o,sendMessageToPeer:a,broadcast:s}}e.SewerPeer=r}(window,document),function(e,t,n){function r(t){function n(){requestAnimationFrame(n),r()}function r(){a.render(l,i)}function o(){var e=s.width(),t=s.height();i.aspect=e/t,i.updateProjectionMatrix(),a.setSize(e,t),r()}var i,s,a,c,l;t.sewerBus;this.init=function(t){s=$(t),i=new THREE.PerspectiveCamera(70,s.width(),s.height(),1,5e3),l=new THREE.Scene,c=new THREE.Object3D,l.add(c),a=new THREE.CSS3DRenderer,a.setSize(e.innerWidth,e.innerHeight),s.append(a.domElement),e.addEventListener("resize",o,!1),n()},this.getScene=function(){return l},this.getCamera=function(){return i}}e.Sewer3d=r}(window,document),function(e,t,n){function r(e){function n(e,t){var n=o.getScene(),r=new THREE.CSS3DSprite(e);return t&&r.position.copy(t),n.add(r),r}var r=this.sewerBus=new EventEmitter2({newListener:!1,wildcard:!1}),o=this.sewer3d=new Sewer3d({sewerBus:r}),i=this.peer=SewerPeer({sewerBus:r});this.init=function(){o.init(e.container),i.setupClient()},this.createItem=function(e){r.emit("p2p.in.item.add",e),this.peer.broadcast("item.add",e)},this.addItem=function(e){switch(e.type){case"text":var r=t.createElement("div");r.textContent=e.body,n(r,new THREE.Vector3(e.x,e.y,e.z))}},r.on("p2p.in.item.add",function(e){this.addItem(e)}.bind(this))}e.Sewer=r}(window,document),function(e,t,n){$(function(){function e(){i.position.z=o*((new Date).getTime()-r),requestAnimationFrame(e)}var n=new Sewer({container:t.getElementById("opensewer")});n.init();var r=new Date("2015-9-26").getTime(),o=.1,i=n.sewer3d.getCamera();i.position.z=10,i.lookAt(new THREE.Vector3),$("#chatForm").on("submit",function(e){e.preventDefault();var t=$("input[name=chatText]"),i=t.val();t.val("");var s={type:"text",t:(new Date).getTime(),x:0,y:0,z:o*((new Date).getTime()-r),body:i};return console.log(s),n.createItem(s),!1}),$("#newPeerForm").on("submit",function(e){e.preventDefault();var t=$("input[name=newPeerId]"),r=t.val().trim();return r&&(n.peer.connectTo(r),t.val("")),!1}),n.sewerBus.on("p2p.open",function(e){$("#your-id").text(e)}),n.sewerBus.on("p2p.close",function(e){$("#your-id").text("disconnected")}),n.sewerBus.on("p2p.error",function(e,t){$("#your-id").text("Error: "+t)}),requestAnimationFrame(e)})}(window,document);